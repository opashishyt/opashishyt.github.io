name: ğŸš€ Deploy Protected FRP Bypass

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for sensitive files
        run: |
          echo "ğŸ” Scanning for sensitive files..."
          
          SENSITIVE_FILES=(".env" ".git" "credentials.json" "secret.json" "password.txt" "config.php")
          for file in "${SENSITIVE_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âš ï¸  Found sensitive file: $file"
              exit 1
            fi
          done
          
          echo "âœ… No sensitive files found"
  
  build-and-protect:
    name: ğŸ›¡ï¸ Build & Protect
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm install -g clean-css-cli
          npm install -g javascript-obfuscator
          npm install -g html-minifier
          npm install -g uglify-js
      
      - name: Create directories
        run: |
          mkdir -p dist
          mkdir -p dist/css
          mkdir -p dist/js
          mkdir -p dist/assets
          mkdir -p dist/protection
      
      - name: Minify CSS
        run: |
          echo "ğŸ¨ Minifying CSS..."
          if [ -f "style.css" ]; then
            cleancss -o dist/css/style.min.css style.css
            echo "âœ… CSS minified"
          else
            echo "âš ï¸ style.css not found"
          fi
      
      - name: Obfuscate JavaScript
        run: |
          echo "ğŸ” Obfuscating JavaScript..."
          
          # Obfuscate main script
          if [ -f "script.js" ]; then
            javascript-obfuscator script.js \
              --output dist/js/script.min.js \
              --compact true \
              --control-flow-flattening true \
              --control-flow-flattening-threshold 0.75 \
              --dead-code-injection true \
              --dead-code-injection-threshold 0.4 \
              --debug-protection true \
              --debug-protection-interval 2000 \
              --disable-console-output true \
              --identifier-names-generator 'mangled' \
              --identifiers-prefix 'frp' \
              --rename-globals true \
              --rename-properties true \
              --self-defending true \
              --string-array true \
              --string-array-encoding 'rc4' \
              --string-array-threshold 0.8 \
              --string-array-index-shift true \
              --string-array-wrappers-count 5 \
              --string-array-wrappers-chained-calls true \
              --string-array-wrappers-parameters-max-count 4 \
              --split-strings true \
              --split-strings-chunk-length 10 \
              --target 'browser' \
              --transform-object-keys true \
              --unicode-escape-sequence true
            echo "âœ… Main script obfuscated"
          fi
          
          # Obfuscate protection scripts
          for file in protection/*.js; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              javascript-obfuscator "$file" \
                --output dist/js/$filename \
                --compact true \
                --control-flow-flattening true \
                --debug-protection true \
                --disable-console-output true \
                --self-defending true
              echo "âœ… Obfuscated: $filename"
            fi
          done
      
      - name: Minify HTML
        run: |
          echo "ğŸ“„ Minifying HTML..."
          if [ -f "index.html" ]; then
            html-minifier \
              --collapse-whitespace \
              --remove-comments \
              --remove-redundant-attributes \
              --remove-script-type-attributes \
              --remove-style-link-type-attributes \
              --minify-css true \
              --minify-js true \
              index.html -o dist/index.html
            echo "âœ… HTML minified"
          fi
          
          if [ -f "404.html" ]; then
            html-minifier \
              --collapse-whitespace \
              --remove-comments \
              404.html -o dist/404.html
            echo "âœ… 404.html minified"
          fi
      
      - name: Copy assets
        run: |
          echo "ğŸ“ Copying assets..."
          if [ -d "assets" ]; then
            cp -r assets/* dist/assets/ 2>/dev/null || :
            echo "âœ… Assets copied"
          fi
      
      - name: Copy protection files
        run: |
          echo "ğŸ›¡ï¸ Copying protection files..."
          cp robots.txt dist/ 2>/dev/null || :
          cp _config.yml dist/ 2>/dev/null || :
          cp .nojekyll dist/ 2>/dev/null || :
          cp CNAME dist/ 2>/dev/null || :
          echo "âœ… Protection files copied"
      
      - name: Remove source files
        run: |
          echo "ğŸ—‘ï¸ Removing source files from dist..."
          rm -f dist/script.js 2>/dev/null || :
          rm -f dist/style.css 2>/dev/null || :
          rm -f dist/*.map 2>/dev/null || :
          rm -rf dist/source 2>/dev/null || :
          rm -rf dist/src 2>/dev/null || :
          echo "âœ… Source files removed"
      
      - name: Set permissions
        run: |
          echo "ğŸ”§ Setting file permissions..."
          find dist -type f -exec chmod 644 {} \;
          find dist -type d -exec chmod 755 {} \;
          echo "âœ… Permissions set"
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: ./dist
  
  deploy:
    name: ğŸŒ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-and-protect
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
  security-headers:
    name: ğŸ›¡ï¸ Apply Security Headers
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Security Headers Check
        run: |
          echo "âœ… Security headers will be applied via _config.yml"
          echo "   - X-Content-Type-Options: nosniff"
          echo "   - X-Frame-Options: DENY"
          echo "   - Referrer-Policy: no-referrer"
          echo "   - Cache-Control: no-cache"
  
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy, security-headers]
    if: success()
    
    steps:
      - name: Deployment Success
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Your site is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          echo ""
          echo "âœ… Protection Features Enabled:"
          echo "   - JavaScript Obfuscated"
          echo "   - CSS Minified"
          echo "   - HTML Compressed"
          echo "   - Source Files Removed"
          echo "   - Anti-Download Active"
          echo "   - DevTools Blocked"
          echo "   - Dynamic Watermarks"
          echo "   - URL Encryption"